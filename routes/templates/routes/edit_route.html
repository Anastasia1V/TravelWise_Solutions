{% extends 'base.html' %}
{% block content %}
<h2>Редактировать маршрут "{{ route.name }}"</h2>

<form method="post">{% csrf_token %}
  <label>Название:</label>
  <input name="name" value="{{ route.name }}"><br><br>

  <!-- контейнер для динамических полей -->
  <div id="fields">
    {% for item in route.details %}
      <div class="field-block" data-idx="{{ forloop.counter0 }}">
        <input type="hidden" name="desc_{{ forloop.counter0 }}" value="{{ item.desc }}">
        <input type="hidden" name="type_{{ forloop.counter0 }}" value="{{ item.type }}">

        {% if item.type == 'text' %}
          <span>Заметка:</span>
          <input type="text" name="val_{{ forloop.counter0 }}" value="{{ item.value }}">
        {% elif item.type == 'time' %}
          <span>Время:</span>
          Описание: <input type="text" name="desc_{{ forloop.counter0 }}" value="{{ item.desc }}">
          Время: <input type="time" name="val_{{ forloop.counter0 }}" value="{{ item.value }}">
        {% elif item.type == 'time_range' %}
          <span>Диапазон времени:</span>
          Описание: <input type="text" name="desc_{{ forloop.counter0 }}" value="{{ item.desc }}">
          Начало: <input type="time" name="val_{{ forloop.counter0 }}" value="{{ item.value.0 }}">
          Конец:  <input type="time" name="val2_{{ forloop.counter0 }}" value="{{ item.value.1 }}">
        {% elif item.type == 'date' %}
          <span>Дата:</span>
          Описание: <input type="text" name="desc_{{ forloop.counter0 }}" value="{{ item.desc }}">
          Дата: <input type="date" name="val_{{ forloop.counter0 }}" value="{{ item.value }}">
        {% elif item.type == 'date_range' %}
          <span>Диапазон дат:</span>
          Описание: <input type="text" name="desc_{{ forloop.counter0 }}" value="{{ item.desc }}">
          Начало: <input type="date" name="val_{{ forloop.counter0 }}" value="{{ item.value.0 }}">
          Конец:  <input type="date" name="val2_{{ forloop.counter0 }}" value="{{ item.value.1 }}">
        {% elif item.type == 'flight' %}
          <span>Рейс:</span>
          Описание: <input type="text" name="desc_{{ forloop.counter0 }}" value="{{ item.desc }}">
          Номер рейса: <input type="text" name="val_{{ forloop.counter0 }}" value="{{ item.value }}">
        {% elif item.type == 'hotel' %}
          <span>Гостиница:</span>
          Описание: <input type="text" name="desc_{{ forloop.counter0 }}" value="{{ item.desc }}">
          Название гостиницы: <input type="text" name="val_{{ forloop.counter0 }}" value="{{ item.value }}">
        {% endif %}

        <button type="button" onclick="removeField(this)">Удалить</button>
        <br><br>
      </div>
    {% endfor %}
  </div>

  <input type="hidden" id="total_fields" name="total_fields" value="{{ route.details|length }}">

  <!-- кнопки добавления -->
  <button type="button" onclick="addField('text')">Добавить текст</button>
  <button type="button" onclick="addField('time')">Добавить время</button>
  <button type="button" onclick="addField('time_range')">Добавить диапазон времени</button>
  <button type="button" onclick="addField('date')">Добавить дату</button>
  <button type="button" onclick="addField('date_range')">Добавить диапазон дат</button>
  <button type="button" onclick="addField('flight')">Добавить номер рейса</button>
  <button type="button" onclick="addField('hotel')">Добавить гостиницу</button>

  <br><br>
  <button type="submit">Сохранить изменения</button>
</form>

<script>
  let idx = {{ route.details|length }};
  function addField(type) {
    const container = document.getElementById('fields');
    const i = idx++;
    document.getElementById('total_fields').value = idx;

    let html = `<div class="field-block" data-idx="${i}">
      <input type="hidden" name="desc_${i}" value="">
      <input type="hidden" name="type_${i}" value="${type}">`;

    if (type === 'text') {
      html += `<span>Заметка:</span>
               <input type="text" name="val_${i}"><br>`;
    }
    else if (type === 'time') {
      html += `<span>Время:</span>
               Описание: <input type="text" name="desc_${i}" placeholder="Описание">
               Время: <input type="time" name="val_${i}"><br>`;
    }
    else if (type === 'time_range') {
      html += `<span>Диапазон времени:</span>
               Описание: <input type="text" name="desc_${i}" placeholder="Описание">
               Начало: <input type="time" name="val_${i}">
               Конец:  <input type="time" name="val2_${i}"><br>`;
    }
    else if (type === 'date') {
      html += `<span>Дата:</span>
               Описание: <input type="text" name="desc_${i}" placeholder="Описание">
               Дата: <input type="date" name="val_${i}"><br>`;
    }
    else if (type === 'date_range') {
      html += `<span>Диапазон дат:</span>
               Описание: <input type="text" name="desc_${i}" placeholder="Описание">
               Начало: <input type="date" name="val_${i}">
               Конец:  <input type="date" name="val2_${i}"><br>`;
    }
    else if (type === 'flight') {
      html += `<span>Рейс:</span>
               Описание: <input type="text" name="desc_${i}" placeholder="Описание">
               Номер рейса: <input type="text" name="val_${i}"><br>`;
    }
    else if (type === 'hotel') {
      html += `<span>Гостиница:</span>
               Описание: <input type="text" name="desc_${i}" placeholder="Описание">
               Название гостиницы: <input type="text" name="val_${i}"><br>`;
    }

    html += `<button type="button" onclick="removeField(this)">Удалить</button><br><br></div>`;
    container.insertAdjacentHTML('beforeend', html);
  }

  function removeField(button) {
    const block = button.closest('.field-block');
    block.remove();
    reindexFields();
  }

  function reindexFields() {
    const blocks = Array.from(document.querySelectorAll('.field-block'));
    idx = blocks.length;
    document.getElementById('total_fields').value = idx;

    blocks.forEach((block, newIndex) => {
      block.dataset.idx = newIndex;
      // для каждого <input> внутри блока
      Array.from(block.querySelectorAll('input')).forEach(input => {
        // переименовываем name=..._<oldIndex> → name=..._<newIndex>
        input.name = input.name.replace(/_(\d+)$/, `_${newIndex}`);
      });
    });
  }
</script>
{% endblock %}
